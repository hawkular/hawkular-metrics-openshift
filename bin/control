#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

function start() {
   echo "Starting RHQ Metrics cartridge"
   $OPENSHIFT_DATA_DIR/cassandra/bin/cassandra
   export CQLSH_HOST=$OPENSHIFT_RHQM_IP
   export CQLSH_PORT=19160

   export CASSANDRA_CQL_PORT=19042
   export CASSANDRA_NODES=$OPENSHIFT_RHQM_IP
   sleep 15

   $OPENSHIFT_DATA_DIR/wildfly/bin/standalone.sh -b $OPENSHIFT_RHQM_IP -bmanagement=$OPENSHIFT_RHQM_IP -Drhq-metrics.backend=$OPENSHIFT_RHQ_METRICS_BACKEND -Drhq-metrics.cassandra-nodes=$CASSANDRA_NODES -Drhq-metrics.cassandra-cql-port=$CASSANDRA_CQL_PORT 2>&1 &
}

function stop() {
   echo "Stopping RHQ Metrics cartridge"

   PIDS_TO_KILL=`ps -ef | grep cassandra | grep -v grep | awk '{ print $2 }'`
   if [ ! -z "$PIDS_TO_KILL" ]
   then
      kill "$PIDS_TO_KILL" > /dev/null 2>&1
   fi

   PIDS_TO_KILL=`ps -ef | grep standalone | grep -v grep | awk '{ print $2 }'`
   if [ ! -z "$PIDS_TO_KILL" ]
   then
      kill "$PIDS_TO_KILL" > /dev/null 2>&1
   fi

   PIDS_TO_KILL=`ps -ef | grep java | grep -v grep | awk '{ print $2 }'`
   if [ ! -z "$PIDS_TO_KILL" ]
   then
      kill "$PIDS_TO_KILL" > /dev/null 2>&1
   fi
}

function restart() {
    stop
    start
}

function status() {
  client_result "Application is running"
}

function reload() {
    client_result "Reloading RHQ metrics cartridge"
    restart
}

function tidy() {
  client_message "Emptying diy logs in dir: $OPENSHIFT_LOG_DIR"
}

case "$1" in
  start)     start ;;
  stop)      stop ;;
  restart)   restart ;;
  status)    status ;;
  reload)    reload ;;
  tidy)      tidy ;;
  *)         exit 0
esac
